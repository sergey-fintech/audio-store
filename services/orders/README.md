# Микросервис "Заказы"

Микросервис для создания и управления заказами в системе аудиокниг.

## Описание

Микросервис "Заказы" отвечает за:
- Создание новых заказов на основе корзины покупок
- Валидацию корзины через микросервис "Корзина"
- Транзакционное создание заказов и позиций заказа
- Управление статусами заказов
- Получение информации о заказах

## Архитектура

### DDD (Domain-Driven Design)
- **Агрегат Order**: Корневая сущность заказа
- **OrderItem**: Часть агрегата Order (позиция заказа)
- **OrderService**: Доменный сервис для бизнес-логики

### Микросервисная архитектура
- Взаимодействие с микросервисом "Корзина" (порт 8002)
- Взаимодействие с микросервисом "Каталог" (порт 8001)
- Независимая база данных заказов

## API Endpoints

### POST /api/v1/orders
Создает новый заказ.

**Входные данные:**
```json
{
  "items": [
    {
      "audiobook_id": 1,
      "quantity": 2
    },
    {
      "audiobook_id": 3,
      "quantity": 1
    }
  ]
}
```

**Процесс создания:**
1. Принимает "сырой" состав корзины
2. Обращается к микросервису "Корзина" для валидации
3. Транзакционно создает заказ и позиции
4. Возвращает информацию о созданном заказе

**Ответ:**
```json
{
  "id": 1,
  "order_number": "ORD-20240101000000-12345678",
  "total_amount": 300.00,
  "status": "pending",
  "items": [
    {
      "id": 1,
      "audiobook_id": 1,
      "title": "Название книги",
      "price_per_unit": 100.00,
      "quantity": 2,
      "total_price": 200.00,
      "created_at": "2024-01-01T00:00:00Z"
    }
  ],
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": null
}
```

### GET /api/v1/orders/{order_id}
Получает заказ по ID.

### GET /api/v1/orders
Получает список всех заказов с пагинацией.

### PUT /api/v1/orders/{order_id}/status
Обновляет статус заказа.

### GET /health
Проверка состояния сервиса.

## Модели данных

### Order (Заказ)
- `id`: Уникальный идентификатор
- `order_number`: Уникальный номер заказа
- `total_amount`: Общая сумма заказа
- `status`: Статус заказа (pending, confirmed, processing, shipped, delivered, cancelled)
- `created_at`: Дата создания
- `updated_at`: Дата обновления

### OrderItem (Позиция заказа)
- `id`: Уникальный идентификатор
- `order_id`: Ссылка на заказ
- `audiobook_id`: ID аудиокниги
- `title`: Название аудиокниги (фиксируется на момент покупки)
- `price_per_unit`: Цена за единицу (фиксируется на момент покупки)
- `quantity`: Количество
- `created_at`: Дата создания

## Бизнес-логика

### Создание заказа
1. **Валидация корзины**: Обращение к микросервису "Корзина" для проверки товаров и расчета стоимости
2. **Транзакционность**: Атомарное создание заказа и всех позиций
3. **Фиксация цен**: Цены товаров фиксируются на момент покупки
4. **Генерация номера**: Уникальный номер заказа генерируется автоматически

### Статусы заказов
- `pending`: Ожидает подтверждения
- `confirmed`: Подтвержден
- `processing`: В обработке
- `shipped`: Отправлен
- `delivered`: Доставлен
- `cancelled`: Отменен

## Запуск

### Требования
- Python 3.8+
- FastAPI
- SQLAlchemy
- httpx
- uvicorn

### Установка зависимостей
```bash
pip install fastapi uvicorn sqlalchemy httpx
```

### Запуск сервиса
```bash
cd services/orders
python run_app.py
```

Сервис будет доступен по адресу: http://localhost:8003

### API документация
- Swagger UI: http://localhost:8003/docs
- ReDoc: http://localhost:8003/redoc

## Тестирование

### Запуск тестов
```bash
cd services/orders
python test_orders.py
```

### Тесты покрывают
- Создание заказов
- Валидацию входных данных
- Обработку ошибок
- Взаимодействие с микросервисом корзины

## Интеграция

### Микросервис "Корзина"
- **URL**: http://localhost:8002/api/v1/cart/calculate
- **Метод**: POST
- **Назначение**: Валидация корзины и расчет стоимости

### Микросервис "Каталог"
- **URL**: http://localhost:8001/api/v1/audiobooks/{id}
- **Метод**: GET
- **Назначение**: Получение информации об аудиокнигах

## Мониторинг

### Health Check
```bash
curl http://localhost:8003/health
```

### Логирование
Сервис выводит логи в консоль с уровнем INFO.

## Безопасность

- Валидация входных данных через Pydantic
- Обработка ошибок и исключений
- Транзакционность операций
- Проверка доступности зависимых сервисов

## Развертывание

### Docker (опционально)
```dockerfile
FROM python:3.9-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .
CMD ["python", "services/orders/run_app.py"]
```

### Переменные окружения
- `DATABASE_URL`: URL базы данных
- `CART_SERVICE_URL`: URL микросервиса корзины
- `CATALOG_SERVICE_URL`: URL микросервиса каталога 