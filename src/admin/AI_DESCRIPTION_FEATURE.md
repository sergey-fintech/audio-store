# AI-генерация описаний в админ-панели

## Обзор

В админ-панель добавлена функциональность AI-генерации описаний для аудиокниг с использованием эндпоинта-оркестратора.

## Новая функциональность

### 1. Кнопка "AI-описание"

В каждой строке таблицы товаров добавлена кнопка **"AI-описание"** с классом `generate-description-btn`.

**Расположение:** В последней колонке "Действия" рядом с кнопками "Редактировать" и "Удалить".

### 2. Процесс генерации

При нажатии на кнопку "AI-описание":

1. **Получение ID товара** из атрибута `data-product-id`
2. **POST запрос** к эндпоинту-оркестратору:
   ```
   http://localhost:8005/api/v1/recommendations/generate-description/{productId}
   ```
3. **Payload:**
   ```json
   {
     "model": "gemini-pro"
   }
   ```
4. **Динамическое обновление** ячейки описания без перезагрузки страницы

### 3. Визуальные эффекты

#### Состояние загрузки кнопки:
- Кнопка становится неактивной
- Текст меняется на "Генерация..."
- Прозрачность снижается до 60%

#### Обновление ячейки описания:
- Содержимое ячейки заменяется на новое описание
- Ячейка подсвечивается зеленым цветом (#d4edda)
- Эффект исчезает через 2 секунды

### 4. Обработка ошибок

- **Уведомления об ошибках** отображаются в верхней части страницы
- **Логирование** всех операций в консоль браузера
- **Graceful degradation** - при ошибке кнопка возвращается в исходное состояние

## Технические детали

### Новые функции в `admin.js`:

1. **`generateDescriptionForProduct(productId, buttonElement)`**
   - Основная функция генерации описания
   - Управляет состоянием кнопки
   - Обрабатывает ответ от API

2. **`setDescriptionButtonLoading(buttonElement, isLoading)`**
   - Управляет визуальным состоянием кнопки
   - Изменяет текст и прозрачность

3. **`updateDescriptionCell(productId, newDescription)`**
   - Обновляет содержимое ячейки описания
   - Добавляет визуальные эффекты
   - Использует `escapeHtml()` для безопасности

### Модификации существующего кода:

1. **Функция `fetchAndRenderProducts()`:**
   - Добавлен класс `description-cell` к ячейкам описания
   - Добавлен атрибут `data-product-id` для идентификации
   - Добавлена кнопка "AI-описание" в колонку действий

2. **Обработчик событий таблицы:**
   - Добавлена обработка кликов по кнопке `generate-description-btn`
   - Интегрирована с существующей логикой делегирования событий

## API Интеграция

### Эндпоинт-оркестратор:
```
POST /api/v1/recommendations/generate-description/{productId}
```

### Процесс оркестрации:
1. **Шаг 1:** Получение данных книги из catalog сервиса
2. **Шаг 2:** Создание промпта для LLM
3. **Шаг 3:** Генерация описания через OpenRouter API
4. **Шаг 4:** Обновление описания в catalog сервисе

### Ответ API:
```json
{
  "product_id": 1,
  "generated_description": "Привлекательное описание аудиокниги...",
  "model": "google/gemini-pro-1.5",
  "model_alias": "gemini-pro",
  "success": true
}
```

## Безопасность

- **Экранирование HTML** с помощью `escapeHtml()` для предотвращения XSS
- **Валидация данных** на стороне сервера
- **Обработка ошибок** без раскрытия внутренней логики

## Совместимость

- **Браузеры:** Современные браузеры с поддержкой ES6+
- **API:** Требует запущенные сервисы:
  - Catalog Service (порт 8002)
  - AI Recommender Service (порт 8005)
- **Зависимости:** Никаких дополнительных библиотек не требуется

## Использование

1. Откройте админ-панель
2. Найдите товар в таблице
3. Нажмите кнопку **"AI-описание"** в колонке "Действия"
4. Дождитесь завершения генерации
5. Описание автоматически обновится в таблице

## Отладка

Для отладки откройте консоль браузера (F12) и следите за логами:
- `Генерируем описание для товара {productId}`
- `Получен ответ от AI-оркестратора: {result}`
- `Ячейка описания для товара {productId} обновлена`
